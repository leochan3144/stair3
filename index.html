<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Stair Game - Algebra Challenge</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TweenMax.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background-color: black;
      font-family: Arial, sans-serif;
      touch-action: none; /* Prevent scroll */
    }

    canvas {
      display: block;
      max-width: 100%;
      height: auto;
    }

    #startBtn {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 40px;
      width: 80%;
      max-width: 300px;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 500px;
      outline: none;
      font-size: 30px;
      letter-spacing: 1px;
      cursor: pointer;
      border: none;
      box-shadow: 0px 0px 20px rgba(255, 255, 255, 0.3);
      z-index: 10;
      white-space: nowrap;
    }

    #startBtn:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    /* Leaderboard styles */
    #leaderboard {
      display: none; 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px;
      border-radius: 15px;
      font-size: 16px;
      z-index: 25;
      width: 85%;
      max-width: 350px;
      box-shadow: 0 0 20px rgba(83, 211, 55, 0.5);
      border: 2px solid #53d337;
      max-height: 80vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    
    #leaderboard h3 {
      margin: 0 0 15px 0;
      text-align: center;
      color: #ffdd38;
      font-size: 22px;
    }
    
    #leaderboard ol {
      padding-left: 25px;
      margin: 0;
    }
    
    #leaderboard li {
      margin-bottom: 6px;
      color: white;
      font-size: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 4px 0;
    }
    
    .current-score {
      color: #53d337 !important;
      font-weight: bold;
    }

    #restartBtn {
        display: block;
        margin: 20px auto 0 auto;
        padding: 10px 30px;
        width: 100%;
        background-color: #53d337;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
    }
    
    /* Name input modal */
    #nameModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 30;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: rgba(50, 50, 50, 0.95);
      padding: 30px;
      width: 80%;
      max-width: 300px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
    }
    
    #nameInput {
      padding: 10px;
      font-size: 18px;
      border: 2px solid #53d337;
      border-radius: 5px;
      background-color: #222;
      color: white;
      margin: 15px 0;
      width: 80%;
      text-align: center;
    }
    
    #submitName {
      padding: 10px 30px;
      font-size: 18px;
      background-color: #53d337;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .modal-title {
      color: #ffdd38;
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    /* Touch controls */
    #touchControls {
      position: fixed;
      bottom: 40px;
      width: 100%;
      display: flex;
      justify-content: space-between; 
      padding: 0 20px;
      box-sizing: border-box;
      z-index: 20;
      pointer-events: none; 
    }
    
    .touch-btn {
      pointer-events: auto; 
      width: 80px;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 30px;
      color: white;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.1s;
      backdrop-filter: blur(2px);
    }

    .touch-btn:active {
        background-color: rgba(255, 255, 255, 0.4);
    }
  </style>
</head>
<body>
  <canvas id="mycanvas"></canvas>
  <button id="startBtn" onclick="game.start()">Start Algebra</button>

  <div id="leaderboard">
    <h3>üèÜ Algebra Ranking</h3>
    <ol id="scoresList"></ol>
    <button id="restartBtn" onclick="game.restartGame()">Play again</button>
  </div>

  <div id="nameModal">
    <div class="modal-content">
      <div class="modal-title">New RecordÔºÅ</div>
      <div class="score-display">Basement <span id="currentScoreDisplay" style="color:#53d337; font-weight:bold;">0</span> /F</div>
      <input type="text" id="nameInput" placeholder="Input your name" maxlength="8" autocomplete="off">
      <br>
      <button id="submitName">Submit</button>
    </div>
  </div>
  
  <div id="touchControls">
    <div class="touch-btn" id="leftBtn">‚óÄ</div>
    <div class="touch-btn" id="rightBtn">‚ñ∂</div>
  </div>

  <audio id="musicBg" src="sound/bgm.mp3" preload="auto"></audio>
  <audio id="transmiting" src="sound/step.mp3" preload="auto"></audio>
  <audio id="hurt" src="sound/hurt.mp3" preload="auto"></audio>
  <audio id="fade" src="sound/fade.mp3" preload="auto"></audio>
  <audio id="dead" src="sound/help.mp3" preload="auto"></audio>
  <audio id="step" src="sound/step.mp3" preload="auto"></audio>
  <audio id="jump" src="sound/jump.mp3" preload="auto"></audio>
  <audio id="correct" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio> 
  
  <script>
    //Áí∞Â¢ÉËÆäÊï∏
    var updateFPS = 30
    var showMouse = true
    var time = 0
    var bgColor ="black"
    var ww, wh; 

    //ÊéßÂà∂
    var controls = {
      value: 0
    }
    var gui = new dat.GUI()
    gui.add(controls,"value",-2,2).step(0.01).onChange(function(value){})
    gui.close(); 
    document.querySelector('.dg.ac').style.display = 'none';

    var bgm = document.getElementById('musicBg');
    bgm.volume = 0.4;
    document.getElementById('transmiting').volume=0.3
    document.getElementById('step').volume=0.7
    bgm.addEventListener('ended', function(){
      this.currentTime = 0;
      this.play();
    }, false);

    //------------------------
    // Vec2
    class Vec2{
      constructor(x,y){
        this.x = x
        this.y = y
      }
      set(x,y){
        this.x =x
        this.y =y
      }
      move(x,y){
        this.x+=x
        this.y+=y
      }
      add(v){
        return new Vec2(this.x+v.x,this.y+v.y)
      }
      sub(v){
        return new Vec2(this.x-v.x,this.y-v.y)
      }
      mul(s){
        return new Vec2(this.x*s,this.y*s)
      }
      get length(){
        return Math.sqrt(this.x*this.x+this.y*this.y)
      }
      set length(nv){
        let temp = this.unit.mul(nv)
        this.set(temp.x,temp.y)
      }
      clone(){
        return new Vec2(this.x,this.y)
      }
      toString(){
        return `(${this.x}, ${this.y})`
      }
      equal(v){
        return this.x==v.x && this.y ==v.y
      }
      get angle(){
        return Math.atan2(this.y,this.x)  
      }
      get unit(){
        return this.mul(1/this.length)
      }
      
    }

    //------
    var canvas = document.getElementById("mycanvas")
    var ctx = canvas.getContext("2d")
    ctx.circle= function(v,r){
      this.arc(v.x,v.y,r,0,Math.PI*2)
    }
    ctx.line= function(v1,v2){
      this.moveTo(v1.x,v1.y)
      this.lineTo(v2.x,v2.y)
    }

    function playSound(id){
      var sound = document.getElementById(id);
      sound.currentTime=0
      sound.play().catch(e => console.log(e)); 
    }

    // Uses separate leaderboard key for Algebra
    function getLeaderboard() {
      const saved = localStorage.getItem('stairGameLeaderboard_algebra'); 
      return saved ? JSON.parse(saved) : [];
    }

    function saveLeaderboard(scores) {
      localStorage.setItem('stairGameLeaderboard_algebra', JSON.stringify(scores));
    }

    function updateLeaderboardDisplay() {
      const scores = getLeaderboard();
      const scoresList = document.getElementById('scoresList');
      scoresList.innerHTML = '';
      
      scores.slice(0, 10).forEach((entry, index) => {
        const li = document.createElement('li');
        li.textContent = `${entry.name}: ${entry.score}/F`;
        if (entry.isCurrent) {
          li.classList.add('current-score');
        }
        scoresList.appendChild(li);
      });
    }

    function checkNewRecord(score) {
      const scores = getLeaderboard();
      
      if (scores.length >= 10 && score <= scores[9].score) {
        document.getElementById('leaderboard').style.display = 'block';
        updateLeaderboardDisplay();
        return;
      }

      document.getElementById('currentScoreDisplay').textContent = score;
      document.getElementById('nameModal').style.display = 'flex';
      setTimeout(()=> document.getElementById('nameInput').focus(), 100);
    }

    function submitName() {
      const name = document.getElementById('nameInput').value.trim() || 'Unknown Hero';
      const score = parseInt(document.getElementById('currentScoreDisplay').textContent);
      
      const scores = getLeaderboard();
      const newEntry = { score: score, name: name, isCurrent: true };
      
      scores.forEach(s => s.isCurrent = false);
      
      scores.push(newEntry);
      scores.sort((a, b) => b.score - a.score); 
      
      const top10 = scores.slice(0, 10);
      
      saveLeaderboard(top10);
      
      document.getElementById('nameModal').style.display = 'none';
      document.getElementById('leaderboard').style.display = 'block';
      updateLeaderboardDisplay();
    }

    //ÈÅäÊà≤Áâ©‰ª∂
    class Game{
      constructor(){
        this.player = null
        this.walls = []
        this.width = Math.min(window.innerWidth, 700) 
        this.height = wh
        this.walltypes = [
          "normal","jump","slideLeft","slideRight",
          "hurt","fade"
        ]
        this.hurt=0
        this.playing=false
        this.keystatus = {
          left: false,
          right: false,
          up: false,
          down: false,
        }
        this.time=0
        
        this.mathQuestion = "";
        this.correctAnswer = "";
        this.wrongAnswer = "";
      }
      
      generateMathProblem() {
        const vars = ["x", "y", "xy", "a", "b"];
        const v = vars[Math.floor(Math.random() * vars.length)];
        
        // Coefficients (1 to 12)
        let n1 = Math.floor(Math.random() * 12) + 1;
        let n2 = Math.floor(Math.random() * 12) + 1;
        
        const isAddition = Math.random() > 0.5;
        let resultVal;

        // Generate Question
        if (isAddition) {
            this.mathQuestion = `${n1}${v} + ${n2}${v} = ?`;
            resultVal = n1 + n2;
        } else {
            // Subtraction (can result in negative)
            this.mathQuestion = `${n1}${v} - ${n2}${v} = ?`;
            resultVal = n1 - n2;
        }

        // Helper: Formats the algebraic term
        // Handles: 1x -> x, -1x -> -x, 0 -> 0, x^2 -> x¬≤
        const format = (val, vari, isSquare) => {
            if (val === 0) return "0";
            
            let s = vari;
            if (isSquare) s += "¬≤"; // Unicode superscript 2
            
            if (val === 1) return s;
            if (val === -1) return "-" + s;
            return val + s;
        };

        this.correctAnswer = format(resultVal, v, false);

        // Generate Wrong Answer (Distractor)
        let wrongVal;
        let isSquareError = false;
        let isVarError = false; 

        const errorType = Math.random();
        
        if (errorType < 0.5) {
            // 1. Arithmetic error (coefficient wrong)
            let offset = Math.floor(Math.random() * 5) + 1;
            if (Math.random() > 0.5) offset = -offset;
            wrongVal = resultVal + offset;
            if (wrongVal === resultVal) wrongVal += 1;
        } else if (errorType < 0.8) {
            // 2. Power error (display x¬≤)
            wrongVal = resultVal;
            // If result is 0, 0¬≤ is same as 0, so force arithmetic error
            if (wrongVal === 0) {
                 wrongVal = 1; 
            } else {
                 isSquareError = true;
            }
        } else {
            // 3. Missing variable error (just the number)
            wrongVal = resultVal;
            isVarError = true;
        }

        if (isVarError) {
            // Display just the number (e.g. 5x -> 5)
            this.wrongAnswer = wrongVal.toString();
        } else {
            this.wrongAnswer = format(wrongVal, v, isSquareError);
        }
        
        // Collision check: ensure wrong != correct
        if (this.wrongAnswer === this.correctAnswer) {
            this.wrongAnswer = format(resultVal + 2, v, false);
        }
      }

      init(){
        this.walls=[]
        this.width = Math.min(window.innerWidth, 700)
        this.generateMathProblem(); 
        
        let initialWallWidth = this.width < 400 ? 120 : 150;

        for(var i=0;i<wh/150;i++){
          this.walls.push(new Wall({
            p: new Vec2(Math.random()*(this.width - initialWallWidth) + initialWallWidth/2, i*150+100),
            width: initialWallWidth,
            type: "normal" 
          })) 
        }
        this.player = new Player({
          p: new Vec2(this.width/2, 200)
        })    
      }
      
      start(){
        document.getElementById('musicBg').play().catch(e=>console.log("Audio play failed"));
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'none';
        this.init()
        this.playing=true
        this.time=0
      }
      
      restartGame() {
        document.getElementById('leaderboard').style.display = 'none';
        this.start();
      }

      end(){
        document.getElementById('startBtn').style.display = 'none'; 
        playSound('dead');  
        this.playing=false
        
        const finalScore = parseInt(this.time/100);
        checkNewRecord(finalScore);
      }
      
      update(){
        this.time++
        this.player.update()
        if (this.keystatus.left){
          this.player.p.x-=8
        }
        if (this.keystatus.right){
          this.player.p.x+=8
        }
        
        if (time%20==0){
          let newType = this.walltypes[parseInt(Math.random()*this.walltypes.length)];
          let wWidth = this.width < 400 ? 120 : 150;
          let safeX = Math.random() * (this.width - wWidth) + wWidth/2;

          let newWall = new Wall({
            p: new Vec2(safeX, this.height),
            width: wWidth,
            type: newType
          });
          
          if (newType === "normal" || newType === "jump") {
            const roll = Math.random();
            if (roll < 0.4) {
                newWall.label = this.correctAnswer;
            } else if (roll < 0.8) {
                newWall.label = this.wrongAnswer;
            }
          }
          
          this.walls.push(newWall);
        }
        
        let touching = false
        this.walls.forEach(wall=>{  
          wall.update() 
          if (wall.p.x-wall.width/2<this.player.p.x+this.player.width/2
              &&   wall.p.x+wall.width/2>this.player.p.x-this.player.width/2){
            if (this.player.p.y>wall.p.y 
                && this.player.p.y<wall.p.y+wall.height+10){ 
              touching=true
              wall.step(this.player)
              this.player.lastBlock=wall
            }
          }
        }) 
        
        if (!touching){
          this.player.lastBlock=null
          document.getElementById("transmiting").pause()
        }

        this.walls = this.walls.filter(wall=>wall.active)
        
        if (this.player.p.y-this.player.height<0){
          if (this.hurt==0){   
            this.hurt=1
            this.player.bloodDelta(-2)
            this.player.v.y=2
            this.player.p.y=10
            TweenMax.to(this,0.5,{hurt: 0})
          }
        }
        
        if (this.player.p.x-this.player.width/2<0){
          this.player.p.x=this.player.width/2
        }
        if (this.player.p.x+this.player.width/2>this.width){
          this.player.p.x=this.width-this.player.width/2
        }
        
        if (this.player.p.y>wh+this.player.height){
          game.end()
        }
      }
      
      draw(){
        ctx.save()
          ctx.translate(ww/2-this.width/2,0)
          let span = this.width/60
          ctx.beginPath()
          for(var i=0;i<=this.width/span;i++){
            ctx.lineTo(i*span,(i%2)*30)
          }  
          ctx.fillStyle="white"
          ctx.fill()
        
          ctx.beginPath()
          ctx.moveTo(0,0)
          ctx.lineTo(0,wh)
          ctx.moveTo(this.width,0)
          ctx.lineTo(this.width,wh)
          ctx.strokeStyle="rgba(255,255,255,0.3)"
          ctx.stroke()
        
          this.player.draw()
          this.walls.forEach(wall=>wall.draw())
        ctx.restore()
        
        ctx.fillStyle="rgba(255,0,0,"+this.hurt+")"
        ctx.fillRect(0,0,ww,wh)
        
        this.player.drawBlood()
        
        ctx.textAlign = "center"; 
        ctx.fillStyle='white';
        
        let fontSize = Math.min(ww / 12, 40); 
        let uiCenterX = ww / 2;
        
        ctx.font = fontSize + "px Arial";
        ctx.fillText("BasementÔºö" + (parseInt(this.time/100)) + "/F", uiCenterX, 100);
        
        ctx.fillStyle='#ffdd38';
        ctx.font = "bold " + (fontSize * 0.9) + "px Arial";
        ctx.fillText("Simplify: " + this.mathQuestion, uiCenterX, 150);
        
        ctx.textAlign = "start"; 
      }
    }

    //Áé©ÂÆ∂Áâ©‰ª∂
    class Player{
      constructor(args){
        let def = {
          p: new Vec2(0,0),
          v: new Vec2(0,0),
          a: new Vec2(0,1), 
          width: 40,
          height: 55,
          blood: 10,
          maxBlood: 10,
          lastBlock: null,
        }
        Object.assign(def,args)
        Object.assign(this,def)
      }
      update(){
        this.p=this.p.add(this.v)
        this.v=this.v.add(this.a)
        
      }
      draw(){
        ctx.beginPath()
        ctx.save()
          ctx.translate(this.p.x,this.p.y)
          ctx.fillStyle="#0047ba"
          ctx.fillRect(-this.width/2,-this
